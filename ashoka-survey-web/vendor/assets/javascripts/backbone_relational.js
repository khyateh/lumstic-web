!function(){"use strict";var e,t,i;"undefined"==typeof window?(e=require("underscore"),t=require("backbone"),i=module.exports=t):(e=window._,t=window.Backbone,i=window),t.Relational={showWarnings:!0},t.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},t.BlockingQueue=function(){this._queue=[]},e.extend(t.BlockingQueue.prototype,t.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){for(;this._queue&&this._queue.length;)this._queue.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),t.Relational.eventQueue=new t.BlockingQueue,t.Store=function(){this._collections=[],this._reverseRelations=[],this._subModels=[],this._modelScopes=[i]},e.extend(t.Store.prototype,t.Events,{addModelScope:function(e){this._modelScopes.push(e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(t){e.find(this._subModels,function(i){return e.find(i.subModels,function(e,n){var o=this.getObjectByName(e);return t===o?(i.superModelType._subModels[n]=t,t._superModel=i.superModelType,t._subModelTypeValue=n,t._subModelTypeAttribute=i.superModelType.prototype.subModelTypeAttribute,!0):void 0},this)},this)},addReverseRelation:function(t){var i=e.any(this._reverseRelations,function(i){return e.all(t,function(e,t){return e===i[t]})});if(!i&&t.model&&t.type){this._reverseRelations.push(t);var n=function(t,i){t.prototype.relations||(t.prototype.relations=[]),t.prototype.relations.push(i),e.each(t._subModels,function(e){n(e,i)},this)};n(t.model,t),this.retroFitRelation(t)}},retroFitRelation:function(e){var t=this.getCollection(e.model);t.each(function(t){t instanceof e.model&&new e.type(t,e)},this)},getCollection:function(i){i instanceof t.RelationalModel&&(i=i.constructor);for(var n=i;n._superModel;)n=n._superModel;var o=e.detect(this._collections,function(e){return e.model===n});return o||(o=this._createCollection(n)),o},getObjectByName:function(t){var i=t.split("."),n=null;return e.find(this._modelScopes,function(t){return n=e.reduce(i,function(e,t){return e[t]},t),n&&n!==t?!0:void 0},this),n},_createCollection:function(e){var i;return e instanceof t.RelationalModel&&(e=e.constructor),e.prototype instanceof t.RelationalModel&&(i=new t.Collection,i.model=e,this._collections.push(i)),i},resolveIdForItem:function(i,n){var o=e.isString(n)||e.isNumber(n)?n:null;return null===o&&(n instanceof t.RelationalModel?o=n.id:e.isObject(n)&&(o=n[i.prototype.idAttribute])),o||0===o||(o=null),o},find:function(e,t){var i=this.resolveIdForItem(e,t),n=this.getCollection(e);if(n){var o=n.get(i);if(o instanceof e)return o}return null},register:function(e){var t=this.getCollection(e);if(t){if(t.get(e))throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!");var i=e.collection;t.add(e),e.bind("destroy",this.unregister,this),e.collection=i}},update:function(e){var t=this.getCollection(e);t._onModelEvent("change:"+e.idAttribute,e,t)},unregister:function(e){e.unbind("destroy",this.unregister);var t=this.getCollection(e);t&&t.remove(e)}}),t.Relational.store=new t.Store,t.Relation=function(i,n){return this.instance=i,n=e.isObject(n)?n:{},this.reverseRelation=e.defaults(n.reverseRelation||{},this.options.reverseRelation),this.reverseRelation.type=e.isString(this.reverseRelation.type)?t[this.reverseRelation.type]||t.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.model=n.model||this.instance.constructor,this.options=e.defaults(n,this.options,t.Relation.prototype.options),this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.relatedModel=this.options.relatedModel,e.isString(this.relatedModel)&&(this.relatedModel=t.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()?(i&&(this.keyContents=this.instance.get(this.keySource),this.key!==this.keySource&&this.instance.unset(this.keySource,{silent:!0}),this.instance._relations.push(this)),!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&t.Relational.store.addReverseRelation(e.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),e.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved"),void(i&&(this.initialize(),t.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection),t.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved)))):!1},t.Relation.extend=t.Model.extend,e.extend(t.Relation.prototype,t.Events,t.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(e,t,i){var n=this;e.queue(function(){n.tryAddRelated(e,i)})},_relatedModelRemoved:function(e,t,i){this.removeRelated(e,i)},_modelRemovedFromCollection:function(e){e===this.instance&&this.destroy()},checkPreconditions:function(){var i=this.instance,n=this.key,o=this.model,s=this.relatedModel,l=t.Relational.showWarnings&&"undefined"!=typeof console;if(!o||!n||!s)return l&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,o,n,s),!1;if(!(o.prototype instanceof t.RelationalModel))return l&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,i),!1;if(!(s.prototype instanceof t.RelationalModel))return l&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,s),!1;if(this instanceof t.HasMany&&this.reverseRelation.type===t.HasMany)return l&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(i&&i._relations.length){var r=e.any(i._relations,function(e){var t=this.reverseRelation.key&&e.reverseRelation.key;return e.relatedModel===s&&e.key===n&&(!t||this.reverseRelation.key===e.reverseRelation.key)},this);if(r)return l&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,i,n,s,this.reverseRelation.key),!1}return!0},setRelated:function(t,i){this.related=t,this.instance.acquire(),this.instance.set(this.key,t,e.defaults(i||{},{silent:!0})),this.instance.release()},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key?!0:!1},getReverseRelations:function(t){var i=[],n=e.isUndefined(t)?this.related&&(this.related.models||[this.related]):[t];return e.each(n,function(t){e.each(t.getRelations(),function(e){this._isReverseRelation(e)&&i.push(e)},this)},this),i},sanitizeOptions:function(t){return t=t?e.clone(t):{},t.silent&&(t.silentChange=!0,delete t.silent),t},unsanitizeOptions:function(t){return t=t?e.clone(t):{},t.silentChange&&(t.silent=!0,delete t.silentChange),t},destroy:function(){t.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection),t.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved),e.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),t.HasOne=t.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){e.bindAll(this,"onChange"),this.instance.bind("relational:change:"+this.key,this.onChange);var t=this.findRelated({silent:!0});this.setRelated(t),e.each(this.getReverseRelations(),function(e){e.addRelated(this.instance)},this)},findRelated:function(){var e=this.keyContents,t=null;return e instanceof this.relatedModel?t=e:(e||0===e)&&(t=this.relatedModel.findOrCreate(e,{create:this.options.createModels})),t},onChange:function(i,n,o){if(!this.isLocked()){this.acquire(),o=this.sanitizeOptions(o);var s=e.isUndefined(o._related),l=s?this.related:o._related;if(s)if(this.keyContents=n,n instanceof this.relatedModel)this.related=n;else if(n){var r=this.findRelated(o);this.setRelated(r)}else this.setRelated(null);if(l&&this.related!==l&&e.each(this.getReverseRelations(l),function(e){e.removeRelated(this.instance,o)},this),e.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,o)},this),!o.silentChange&&this.related!==l){var a=this;t.Relational.eventQueue.add(function(){a.instance.trigger("update:"+a.key,a.instance,a.related,o)})}this.release()}},tryAddRelated:function(i,n){if(!this.related){n=this.sanitizeOptions(n);var o=this.keyContents;if(o||0===o){var s=t.Relational.store.resolveIdForItem(this.relatedModel,o);e.isNull(s)||i.id!==s||this.addRelated(i,n)}}},addRelated:function(e){if(e!==this.related){var t=this.related||null;this.setRelated(e),this.onChange(this.instance,e,{_related:t})}},removeRelated:function(e){if(this.related&&e===this.related){var t=this.related||null;this.setRelated(null),this.onChange(this.instance,e,{_related:t})}}}),t.HasMany=t.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:t.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(){if(e.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset"),this.instance.bind("relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,e.isString(this.collectionType)&&(this.collectionType=t.Relational.store.getObjectByName(this.collectionType)),!this.collectionType.prototype instanceof t.Collection)throw new Error("collectionType must inherit from Backbone.Collection");this.setRelated(this.keyContents instanceof t.Collection?this._prepareCollection(this.keyContents):this._prepareCollection()),this.findRelated({silent:!0})},_getCollectionOptions:function(){return e.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions},_prepareCollection:function(e){if(this.related&&this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset),e&&e instanceof t.Collection||(e=new this.collectionType([],this._getCollectionOptions())),e.model=this.relatedModel,this.options.collectionKey){var i=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[i]&&e[i]!==this.instance?t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,i,this.options.collectionKey):i&&(e[i]=this.instance)}return e.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset),e},findRelated:function(i){if(this.keyContents){var n=[];this.keyContents instanceof t.Collection?n=this.keyContents.models:(this.keyContents=e.isArray(this.keyContents)?this.keyContents:[this.keyContents],e.each(this.keyContents,function(e){var t=null;e instanceof this.relatedModel?t=e:(e||0===e)&&(t=this.relatedModel.findOrCreate(e,{create:this.options.createModels})),!t||this.related.getByCid(t)||this.related.get(t)||n.push(t)},this)),n.length&&(i=this.unsanitizeOptions(i),this.related.add(n,i))}},onChange:function(i,n,o){if(o=this.sanitizeOptions(o),this.keyContents=n,e.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance,o)},this),n instanceof t.Collection)this._prepareCollection(n),this.related=n;else{var s;this.related instanceof t.Collection?(s=this.related,s.remove(s.models)):s=this._prepareCollection(),this.setRelated(s),this.findRelated(o)}e.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,o)},this);var l=this;t.Relational.eventQueue.add(function(){!o.silentChange&&l.instance.trigger("update:"+l.key,l.instance,l.related,o)})},tryAddRelated:function(i,n){if(n=this.sanitizeOptions(n),!this.related.getByCid(i)&&!this.related.get(i)){var o=e.any(this.keyContents,function(n){var o=t.Relational.store.resolveIdForItem(this.relatedModel,n);return!e.isNull(o)&&o===i.id},this);o&&this.related.add(i,n)}},handleAddition:function(i,n,o){if(i instanceof t.Model){o=this.sanitizeOptions(o),e.each(this.getReverseRelations(i),function(e){e.addRelated(this.instance,o)},this);var s=this;t.Relational.eventQueue.add(function(){!o.silentChange&&s.instance.trigger("add:"+s.key,i,s.related,o)})}},handleRemoval:function(i,n,o){if(i instanceof t.Model){o=this.sanitizeOptions(o),e.each(this.getReverseRelations(i),function(e){e.removeRelated(this.instance,o)},this);var s=this;t.Relational.eventQueue.add(function(){!o.silentChange&&s.instance.trigger("remove:"+s.key,i,s.related,o)})}},handleReset:function(e,i){i=this.sanitizeOptions(i);var n=this;t.Relational.eventQueue.add(function(){!i.silentChange&&n.instance.trigger("reset:"+n.key,n.related,i)})},addRelated:function(e,t){var i=this;t=this.unsanitizeOptions(t),e.queue(function(){!i.related||i.related.getByCid(e)||i.related.get(e)||i.related.add(e,t)})},removeRelated:function(e,t){t=this.unsanitizeOptions(t),(this.related.getByCid(e)||this.related.get(e))&&this.related.remove(e,t)}}),t.RelationalModel=t.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(i,n){var o=this;if(n&&n.collection){this._deferProcessing=!0;var s=function(e){e===o&&(o._deferProcessing=!1,o.processQueue(),n.collection.unbind("relational:add",s))};n.collection.bind("relational:add",s),e.defer(function(){s(o)})}this._queue=new t.BlockingQueue,this._queue.block(),t.Relational.eventQueue.block(),t.Model.apply(this,arguments),t.Relational.eventQueue.unblock()},trigger:function(e){if(e.length>5&&"change"===e.substr(0,6)){var i=this,n=arguments;t.Relational.eventQueue.add(function(){t.Model.prototype.trigger.apply(i,n)})}else t.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(){this.acquire(),this._relations=[],e.each(this.relations,function(i){var n=e.isString(i.type)?t[i.type]||t.Relational.store.getObjectByName(i.type):i.type;n&&n.prototype instanceof t.Relation?new n(this,i):t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid type!",i)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(t){this._isInitialized&&!this.isLocked()&&e.each(this._relations,function(e){var i=this.attributes[e.keySource]||this.attributes[e.key];e.related!==i&&this.trigger("relational:change:"+e.key,this,i,t||{})},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(t){return e.detect(this._relations,function(e){return e.key===t?!0:void 0},this)},getRelations:function(){return this._relations},fetchRelated:function(i,n,o){n||(n={});var s,l=[],r=this.getRelation(i),a=r&&r.keyContents,d=a&&e.select(e.isArray(a)?a:[a],function(i){var n=t.Relational.store.resolveIdForItem(r.relatedModel,i);return!e.isNull(n)&&(o||!t.Relational.store.find(r.relatedModel,n))},this);if(d&&d.length){var h=e.map(d,function(t){var i;if(e.isObject(t))i=r.relatedModel.build(t);else{var n={};n[r.relatedModel.prototype.idAttribute]=t,i=r.relatedModel.build(n)}return i},this);if(r.related instanceof t.Collection&&e.isFunction(r.related.url)&&(s=r.related.url(h)),s&&s!==r.related.url()){var c=e.defaults({error:function(){var t=arguments;e.each(h,function(e){e.trigger("destroy",e,e.collection,n),n.error&&n.error.apply(e,t)})},url:s},n,{add:!0});l=[r.related.fetch(c)]}else l=e.map(h,function(t){var i=e.defaults({error:function(){t.trigger("destroy",t,t.collection,n),n.error&&n.error.apply(t,arguments)}},n);return t.fetch(i)},this)}return l},set:function(i,n,o){t.Relational.eventQueue.block();var s;e.isObject(i)||null===i?(s=i,o=n):(s={},s[i]=n);var l=t.Model.prototype.set.apply(this,arguments);return this._isInitialized||this.isLocked()?s&&this.idAttribute in s&&t.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),t.Relational.store.register(this),this.initializeRelations()),s&&this.updateRelations(o),t.Relational.eventQueue.unblock(),l},unset:function(e,i){t.Relational.eventQueue.block();var n=t.Model.prototype.unset.apply(this,arguments);return this.updateRelations(i),t.Relational.eventQueue.unblock(),n},clear:function(e){t.Relational.eventQueue.block();var i=t.Model.prototype.clear.apply(this,arguments);return this.updateRelations(e),t.Relational.eventQueue.unblock(),i},change:function(){var e=this,i=arguments;t.Relational.eventQueue.add(function(){t.Model.prototype.change.apply(e,i)})},clone:function(){var t=e.clone(this.attributes);return e.isUndefined(t[this.idAttribute])||(t[this.idAttribute]=null),e.each(this.getRelations(),function(e){delete t[e.key]}),new this.constructor(t)},toJSON:function(){if(this.isLocked())return this.id;this.acquire();var i=t.Model.prototype.toJSON.call(this);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in i||(i[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),e.each(this._relations,function(n){var o=i[n.key];if(n.options.includeInJSON===!0)i[n.keyDestination]=o&&e.isFunction(o.toJSON)?o.toJSON():null;else if(e.isString(n.options.includeInJSON))i[n.keyDestination]=o instanceof t.Collection?o.pluck(n.options.includeInJSON):o instanceof t.Model?o.get(n.options.includeInJSON):null;else if(e.isArray(n.options.includeInJSON))if(o instanceof t.Collection){var s=[];o.each(function(t){var i={};e.each(n.options.includeInJSON,function(e){i[e]=t.get(e)}),s.push(i)}),i[n.keyDestination]=s}else if(o instanceof t.Model){var s={};e.each(n.options.includeInJSON,function(e){s[e]=o.get(e)}),i[n.keyDestination]=s}else i[n.keyDestination]=null;else delete i[n.key];n.keyDestination!==n.key&&delete i[n.key]}),this.release(),i}},{setup:function(){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?t.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,e.each(this.prototype.relations,function(i){if(i.model||(i.model=this),i.reverseRelation&&i.model===this){var n=!0;if(e.isString(i.relatedModel)){var o=t.Relational.store.getObjectByName(i.relatedModel);n=o&&o.prototype instanceof t.RelationalModel}var s=e.isString(i.type)?t[i.type]||t.Relational.store.getObjectByName(i.type):i.type;n&&s&&s.prototype instanceof t.Relation&&new s(null,i)}},this),this},build:function(e,t){var i=this;if(this.initializeModelHierarchy(),this._subModels&&this.prototype.subModelTypeAttribute in e){var n=e[this.prototype.subModelTypeAttribute],o=this._subModels[n];o&&(i=o)}return new i(e,t)},initializeModelHierarchy:function(){if(e.isUndefined(this._superModel)||e.isNull(this._superModel))if(t.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.prototype.relations){var i=e.any(this.prototype.relations,function(e){return e.model&&e.model!==this},this);i||(this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations))}}else this._superModel=!1;this.prototype.subModelTypes&&e.keys(this.prototype.subModelTypes).length!==e.keys(this._subModels).length&&e.each(this.prototype.subModelTypes,function(e){var i=t.Relational.store.getObjectByName(e);i&&i.initializeModelHierarchy()})},findOrCreate:function(i,n){var o=t.Relational.store.find(this,i);return e.isObject(i)&&(o?o.set(o.parse?o.parse(i):i,n):(!n||n&&n.create!==!1)&&(o=this.build(i,n))),o}}),e.extend(t.RelationalModel.prototype,t.Semaphore),t.Collection.prototype.__prepareModel=t.Collection.prototype._prepareModel,t.Collection.prototype._prepareModel=function(e,i){if(i||(i={}),e instanceof t.Model)e.collection||(e.collection=this);else{var n=e;i.collection=this,e="undefined"!=typeof this.model.findOrCreate?this.model.findOrCreate(n,i):new this.model(n,i),e._validate(e.attributes,i)||(e=!1)}return e};var n=t.Collection.prototype.__add=t.Collection.prototype.add;t.Collection.prototype.add=function(i,o){o||(o={}),e.isArray(i)||(i=[i]);var s=[];return e.each(i,function(e){e instanceof t.Model||(e=t.Collection.prototype._prepareModel.call(this,e,o)),e instanceof t.Model&&!this.get(e)&&!this.getByCid(e)&&s.push(e)},this),s.length&&(n.call(this,s,o),e.each(s,function(e){this.trigger("relational:add",e,this,o)},this)),this};var o=t.Collection.prototype.__remove=t.Collection.prototype.remove;t.Collection.prototype.remove=function(i,n){return n||(n={}),i=e.isArray(i)?i.slice(0):[i],e.each(i,function(e){e=this.getByCid(e)||this.get(e),e instanceof t.Model&&(o.call(this,e,n),this.trigger("relational:remove",e,this,n))},this),this};var s=t.Collection.prototype.__reset=t.Collection.prototype.reset;t.Collection.prototype.reset=function(e,t){return s.call(this,e,t),this.trigger("relational:reset",this,t),this};var l=t.Collection.prototype.__sort=t.Collection.prototype.sort;t.Collection.prototype.sort=function(e){return l.call(this,e),this.trigger("relational:reset",this,e),this};var r=t.Collection.prototype.__trigger=t.Collection.prototype.trigger;t.Collection.prototype.trigger=function(i){if("add"===i||"remove"===i||"reset"===i){var n=this,o=arguments;"add"===i&&(o=e.toArray(o),e.isObject(o[3])&&(o[3]=e.clone(o[3]))),t.Relational.eventQueue.add(function(){r.apply(n,o)})}else r.apply(this,arguments);return this},t.RelationalModel.extend=function(){var e=t.Model.extend.apply(this,arguments);return e.setup(this),e}}();
